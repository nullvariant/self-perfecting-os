name: Cleanup Old Caches

on:
  workflow_dispatch:
  schedule:
    # æ¯é€±æ—¥æ›œ 3:00 UTCï¼ˆæ—¥æœ¬æ™‚é–“ æœˆæ›œæ—¥ 12:00ï¼‰
    - cron: '0 3 * * 0'

permissions:
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old caches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "ğŸ§¹ Fetching cache list for ${REPO}..."
          
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¢ã‚¯ã‚»ã‚¹æ™‚é–“ã®é™é †ã§å–å¾—
          # æœ€æ–°10ä»¶ã¯ä¿æŒã—ã€ãã‚Œä»¥é™ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
          gh actions-cache list -R "${REPO}" --sort accessed --order desc | \
          tail -n +11 | \
          awk '{print $1}' | \
          while read cache_key; do
            if [ -n "$cache_key" ]; then
              echo "ğŸ—‘ï¸  Deleting cache: $cache_key"
              gh actions-cache delete -R "${REPO}" "$cache_key" --confirm || true
            fi
          done
          
          echo "âœ… Cache cleanup completed"
