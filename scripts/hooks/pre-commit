#!/usr/bin/env bash
#
# Git pre-commit hook: INDEX.md è‡ªå‹•å†ç”Ÿæˆ
#
# ã“ã®ãƒ•ãƒƒã‚¯ã¯ã€docs/ é…ä¸‹ã®ç‰¹å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã€
# è©²å½“ã™ã‚‹ INDEX.md ã‚’è‡ªå‹•çš„ã«å†ç”Ÿæˆã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¾ã™ã€‚
#
# é–¢é€£: ADR-0015 (docs/decisions/active/2025/10/20251030_0015_git-hooks-index-generation_tooling.md)
#

set -e

# ã‚«ãƒ©ãƒ¼å‡ºåŠ›å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
trap 'echo -e "${RED}âŒ INDEX.md ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ${NC}" >&2; exit 1' ERR

echo -e "${BLUE}ğŸ” INDEX.md è‡ªå‹•å†ç”Ÿæˆãƒ•ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­...${NC}"

# ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
STAGED_FILES=$(git diff --cached --name-only)

# å†ç”ŸæˆãŒå¿…è¦ãªå¯¾è±¡ã‚’è¨˜éŒ²ã™ã‚‹ãƒ•ãƒ©ã‚°ï¼ˆé‡è¤‡æ’é™¤ï¼‰
NEED_DECISIONS=0
NEED_PRD=0
NEED_OPERATIONS=0
NEED_GOVERNANCE=0

# å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ã‚’æ¤œçŸ¥
while IFS= read -r file; do
    case "$file" in
        # docs/decisions/ é…ä¸‹ï¼ˆINDEX.md, README.md ã‚’é™¤ã .md ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
        docs/decisions/active/*.md|docs/decisions/active/*/*.md|docs/decisions/active/*/*/*.md|\
        docs/decisions/deprecated/*.md|docs/decisions/deprecated/*/*.md|docs/decisions/deprecated/*/*/*.md|\
        docs/decisions/superseded/*.md|docs/decisions/superseded/*/*.md|docs/decisions/superseded/*/*/*.md)
            if [[ "$file" != *"/INDEX.md" ]] && [[ "$file" != *"/README.md" ]]; then
                NEED_DECISIONS=1
            fi
            ;;
        
        # docs/prd/ é…ä¸‹ï¼ˆINDEX.md, README.md ã‚’é™¤ã .md ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
        docs/prd/active/*.md|docs/prd/implemented/*.md|docs/prd/deprecated/*.md)
            if [[ "$file" != *"/INDEX.md" ]] && [[ "$file" != *"/README.md" ]]; then
                NEED_PRD=1
            fi
            ;;
        
        # docs/operations/ é…ä¸‹ï¼ˆINDEX.md, README.md ã‚’é™¤ã .md ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
        docs/operations/current/*.md|docs/operations/archive/*.md|docs/operations/archive/*/*.md|docs/operations/archive/*/*/*.md)
            if [[ "$file" != *"/INDEX.md" ]] && [[ "$file" != *"/README.md" ]]; then
                NEED_OPERATIONS=1
            fi
            ;;
        
        # docs/governance/ é…ä¸‹ï¼ˆINDEX.md, README.md ã‚’é™¤ã .md, .yml, .yaml ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
        docs/governance/*.md|docs/governance/*.yml|docs/governance/*.yaml)
            if [[ "$file" != *"/INDEX.md" ]] && [[ "$file" != *"/README.md" ]]; then
                NEED_GOVERNANCE=1
            fi
            ;;
    esac
done <<< "$STAGED_FILES"

# å¯¾è±¡ãŒãªã„å ´åˆã¯çµ‚äº†
if [ $NEED_DECISIONS -eq 0 ] && [ $NEED_PRD -eq 0 ] && [ $NEED_OPERATIONS -eq 0 ] && [ $NEED_GOVERNANCE -eq 0 ]; then
    echo -e "${GREEN}âœ… INDEX.md ã®å†ç”Ÿæˆã¯ä¸è¦ã§ã™${NC}"
    exit 0
fi

# docs/decisions/ ã® INDEX.md ã‚’å†ç”Ÿæˆ
if [ $NEED_DECISIONS -eq 1 ]; then
    echo -e "${YELLOW}ğŸ“‹ docs/decisions ã®å¤‰æ›´ã‚’æ¤œçŸ¥ â†’ INDEX.md ã‚’å†ç”Ÿæˆä¸­...${NC}"
    python scripts/generate_index.py --target adr
    git add docs/decisions/INDEX.md
    echo -e "${GREEN}âœ… docs/decisions/INDEX.md ã‚’æ›´æ–°ã—ã¾ã—ãŸ${NC}"
fi

# docs/prd/ ã® INDEX.md ã‚’å†ç”Ÿæˆ
if [ $NEED_PRD -eq 1 ]; then
    echo -e "${YELLOW}ğŸ“‹ docs/prd ã®å¤‰æ›´ã‚’æ¤œçŸ¥ â†’ INDEX.md ã‚’å†ç”Ÿæˆä¸­...${NC}"
    python scripts/generate_index.py --target prd
    git add docs/prd/INDEX.md
    echo -e "${GREEN}âœ… docs/prd/INDEX.md ã‚’æ›´æ–°ã—ã¾ã—ãŸ${NC}"
fi

# docs/operations/ ã® INDEX.md ã‚’å†ç”Ÿæˆ
if [ $NEED_OPERATIONS -eq 1 ]; then
    echo -e "${YELLOW}ğŸ“‹ docs/operations ã®å¤‰æ›´ã‚’æ¤œçŸ¥ â†’ INDEX.md ã‚’å†ç”Ÿæˆä¸­...${NC}"
    python scripts/generate_index.py --target operations
    git add docs/operations/INDEX.md
    echo -e "${GREEN}âœ… docs/operations/INDEX.md ã‚’æ›´æ–°ã—ã¾ã—ãŸ${NC}"
fi

# docs/governance/ ã® INDEX.md ã‚’å†ç”Ÿæˆ
if [ $NEED_GOVERNANCE -eq 1 ]; then
    echo -e "${YELLOW}ğŸ“‹ docs/governance ã®å¤‰æ›´ã‚’æ¤œçŸ¥ â†’ INDEX.md ã‚’å†ç”Ÿæˆä¸­...${NC}"
    python scripts/generate_index.py --target governance
    git add docs/governance/INDEX.md
    echo -e "${GREEN}âœ… docs/governance/INDEX.md ã‚’æ›´æ–°ã—ã¾ã—ãŸ${NC}"
fi

echo -e "${GREEN}âœ… INDEX.md è‡ªå‹•å†ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ${NC}"
echo ""
echo -e "${BLUE}ğŸ’¡ ã“ã®ãƒ•ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸã„å ´åˆã¯ 'git commit --no-verify' ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„${NC}"

exit 0

